<html lang="es"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUVN CORE - Advanced Control</title>
    <style>
        :root {
            --bg-dark: #050a0f;
            --card-bg: rgba(10, 20, 30, 0.9);
            --neon-blue: #00f2ff;
            --neon-pink: #ff0055;
            --neon-green: #39ff14;
            --neon-yellow: #ffea00;
            --text-main: #e0faff;
            --border-color: rgba(0, 242, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: var(--bg-dark);
            background-image: linear-gradient(var(--border-color) 1px, transparent 1px), 
                              linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Utilidades de Navegación */
        .page { display: none; padding: 20px; flex-grow: 1; animation: fadeIn 0.3s ease; }
        .active-page { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(0,0,0,0.5);
            border-bottom: 2px solid var(--neon-blue);
        }

        .logo-section h1 { font-size: 1.4rem; letter-spacing: 2px; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }

        /* Estilos de Botones y Inputs */
        .btn {
            background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue);
            padding: 10px 20px; cursor: pointer; text-transform: uppercase; font-weight: bold; transition: 0.3s;
        }
        .btn:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); }
        .btn-sm { padding: 5px 10px; font-size: 0.7rem; }
        .btn-red { border-color: var(--neon-pink); color: var(--neon-pink); }
        .btn-red:hover { background: var(--neon-pink); color: white; }
        
        input {
            width: 100%; padding: 12px; margin: 10px 0; background: #111; border: 1px solid var(--border-color); color: white;
        }

        /* Menú Home */
        .home-grid {
            display: grid; place-items: center; height: 80vh;
        }
        .menu-box { text-align: center; max-width: 400px; width: 100%; }
        .menu-btn { width: 100%; margin: 15px 0; padding: 20px; font-size: 1.2rem; }

        /* Dashboard Elements */
        .status-header {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .stat-box {
            background: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; text-align: center;
        }
        .grid-sensors {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px;
        }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 15px; position: relative; }
        .temp-val { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        
        /* Controles */
        .control-panel {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;
        }
        .actuator-ctrl {
            border: 1px solid var(--border-color); padding: 15px; text-align: center;
        }
        .lock-indicator {
            background: rgba(255, 234, 0, 0.1); border: 1px solid var(--neon-yellow);
            color: var(--neon-yellow); padding: 10px; margin: 10px 0; display: none;
        }
        .mode-badge { padding: 4px 10px; font-size: 0.8rem; border-radius: 4px; font-weight: bold; }
        .manual-on { background: var(--neon-pink); color: white; }
        .auto-on { background: var(--neon-green); color: black; }

        .disabled-ui { opacity: 0.4; pointer-events: none; }
    </style>
</head>
<body>

    <header>
        <div class="logo-section">
            <h1 onclick="showPage('home')" style="cursor:pointer">TUVN CORE</h1>
        </div>
        <div id="connection-indicator" style="color: var(--neon-green); font-size: 0.8rem;">● ONLINE</div>
    </header>

    <div id="home" class="page">
        <div class="home-grid">
            <div class="menu-box">
                <button class="btn menu-btn" onclick="requestAuth('admin')">1. ADMINISTRADOR</button>
                <button class="btn menu-btn" onclick="requestAuth('operator')">2. OPERADOR</button>
                <button class="btn menu-btn" onclick="showPage('config')">3. CONEXIÓN</button>
            </div>
        </div>
    </div>

    <div id="admin" class="page active-page">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2>ADMIN PANEL</h2>
            <button class="btn btn-sm btn-red" onclick="showPage('home')">LOGOUT</button>
        </div>

        <div class="status-header">
            <div class="stat-box">
                <small>ESTADO SISTEMA</small>
                <div id="adm-mode-val" class="mode-badge manual-on" style="margin-top:10px; display:inline-block;">MANUAL</div>
            </div>
            <div class="stat-box">
                <small>PROMEDIO GLOBAL</small>
                <div id="adm-avg" class="temp-val" style="color:var(--neon-green)">19.2°C</div>
            </div>
        </div>

        <div id="lock-msg" class="lock-indicator" style="display: none;">⚠️ BLOQUEO AUTOMÁTICO ACTIVO (3 MIN)</div>

        <div class="grid-sensors" id="adm-sensors">
                    <div class="card">
                        <small>SENSOR_0</small>
                        <div class="temp-val">16.0°C</div>
                    </div>
                    <div class="card">
                        <small>SENSOR_1</small>
                        <div class="temp-val">16.1°C</div>
                    </div>
                    <div class="card">
                        <small>SENSOR_2</small>
                        <div class="temp-val">16.0°C</div>
                    </div></div>

        <div class="card" style="margin-bottom:20px;">
            <h3 style="margin-bottom:15px; font-size:0.8rem;">CONTROL MANUAL DE SISTEMA</h3>
            <div style="display:flex; gap:20px; align-items:center;">
                <p>MODO MANUAL:</p>
                <button id="btn-toggle-manual" class="btn btn-sm btn-red" onclick="setManualMode()">DESACTIVAR</button>
            </div>
        </div>

        <div class="control-panel" id="manual-controls">
            <div class="actuator-ctrl">
                <h3>ACTUADOR 1</h3>
                <div id="adm-st-1" class="temp-val">ON</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-sm" onclick="sendActuator(1, true)">ON</button>
                    <button class="btn btn-sm btn-red" onclick="sendActuator(1, false)">OFF</button>
                </div>
            </div>
            <div class="actuator-ctrl">
                <h3>ACTUADOR 2</h3>
                <div id="adm-st-2" class="temp-val">OFF</div>
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-sm" onclick="sendActuator(2, true)">ON</button>
                    <button class="btn btn-sm btn-red" onclick="sendActuator(2, false)">OFF</button>
                </div>
            </div>
        </div>
    </div>

    <div id="operator" class="page">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2>OPERATOR MONITOR</h2>
            <button class="btn btn-sm btn-red" onclick="showPage('home')">SALIR</button>
        </div>
        
        <div class="status-header">
            <div class="stat-box">
                <small>PROMEDIO</small>
                <div id="opr-avg" class="temp-val" style="color:var(--neon-blue)">19.2°C</div>
            </div>
            <div class="stat-box">
                <small>MODO</small>
                <div id="opr-mode" style="font-weight:bold; margin-top:5px;">MANUAL</div>
            </div>
        </div>

        <div class="grid-sensors" id="opr-sensors">
                    <div class="card">
                        <small>SENSOR_0</small>
                        <div class="temp-val">16.0°C</div>
                    </div>
                    <div class="card">
                        <small>SENSOR_1</small>
                        <div class="temp-val">16.1°C</div>
                    </div>
                    <div class="card">
                        <small>SENSOR_2</small>
                        <div class="temp-val">16.0°C</div>
                    </div></div>

        <div class="control-panel">
            <div class="actuator-ctrl">
                <small>ACT 1</small>
                <div id="opr-st-1" class="temp-val">ON</div>
            </div>
            <div class="actuator-ctrl">
                <small>ACT 2</small>
                <div id="opr-st-2" class="temp-val">OFF</div>
            </div>
        </div>
    </div>

    <div id="config" class="page">
        <div class="menu-box" style="margin: 0 auto;">
            <h2>CONFIGURACIÓN</h2>
            <input type="text" id="cfg-url" placeholder="URL de Firebase (https://...)">
            <input type="text" id="cfg-key" placeholder="API Key">
            <button class="btn menu-btn" onclick="saveFirebaseConfig()">GUARDAR Y CONECTAR</button>
            <button class="btn menu-btn btn-red" onclick="showPage('home')">VOLVER</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // CONFIGURACIÓN DE SEGURIDAD
        const PASSWORDS = { admin: "admin123", operator: "user123" };
        let db;
        let isManualMode = false;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
        }

        function requestAuth(role) {
            const pass = prompt("Ingrese contraseña de " + role.toUpperCase());
            if (pass === PASSWORDS[role]) {
                showPage(role);
            } else {
                alert("⚠️ Acceso Denegado: Contraseña Incorrecta");
            }
        }

        function saveFirebaseConfig() {
            const url = document.getElementById('cfg-url').value;
            const key = document.getElementById('cfg-key').value;
            localStorage.setItem('fb_url', url);
            localStorage.setItem('fb_key', key);
            location.reload();
        }

        function initFirebase() {
            const url = localStorage.getItem('fb_url');
            const key = localStorage.getItem('fb_key');
            if (!url || !key) return;

            document.getElementById('cfg-url').value = url;
            document.getElementById('cfg-key').value = key;

            const config = { databaseURL: url, apiKey: key };
            firebase.initializeApp(config);
            db = firebase.database();

            document.getElementById('connection-indicator').innerText = "● ONLINE";
            document.getElementById('connection-indicator').style.color = "var(--neon-green)";

            // Listener Sensores
            db.ref('sensores').on('value', snap => {
                const data = snap.val();
                updateSensorsUI(data);
            });

            // Listener Sistema
            db.ref('sistema').on('value', snap => {
                const data = snap.val();
                if (data) updateSystemUI(data);
            });
        }

        function updateSensorsUI(data) {
            if (!data) return;
            const admContainer = document.getElementById('adm-sensors');
            const oprContainer = document.getElementById('opr-sensors');
            admContainer.innerHTML = '';
            oprContainer.innerHTML = '';

            Object.keys(data).forEach(key => {
                const s = data[key];
                const html = `
                    <div class="card">
                        <small>${key.toUpperCase()}</small>
                        <div class="temp-val">${s.temperatura.toFixed(1)}°C</div>
                    </div>`;
                admContainer.innerHTML += html;
                oprContainer.innerHTML += html;
            });
        }

        function updateSystemUI(data) {
            isManualMode = data.modo_manual;
            const isLocked = data.bloqueo_auto;

            // Admin UI
            document.getElementById('adm-avg').innerText = `${data.promedio.toFixed(1)}°C`;
            document.getElementById('adm-st-1').innerText = data.actuador1 ? "ON" : "OFF";
            document.getElementById('adm-st-2').innerText = data.actuador2 ? "ON" : "OFF";
            
            const modeBadge = document.getElementById('adm-mode-val');
            modeBadge.innerText = isManualMode ? "MANUAL" : "AUTOMÁTICO";
            modeBadge.className = `mode-badge ${isManualMode ? 'manual-on' : 'auto-on'}`;
            
            const btnManual = document.getElementById('btn-toggle-manual');
            btnManual.innerText = isManualMode ? "DESACTIVAR" : "ACTIVAR";
            btnManual.className = isManualMode ? "btn btn-sm btn-red" : "btn btn-sm";

            // Bloqueo UI
            const lockMsg = document.getElementById('lock-msg');
            const ctrlPanel = document.getElementById('manual-controls');
            
            lockMsg.style.display = isLocked ? "block" : "none";
            
            if (isManualMode) {
                ctrlPanel.classList.remove('disabled-ui');
            } else {
                ctrlPanel.classList.add('disabled-ui');
            }

            // Operator UI
            document.getElementById('opr-avg').innerText = `${data.promedio.toFixed(1)}°C`;
            document.getElementById('opr-mode').innerText = isLocked ? "BLOQUEADO (3m)" : (isManualMode ? "MANUAL" : "AUTO");
            document.getElementById('opr-st-1').innerText = data.actuador1 ? "ON" : "OFF";
            document.getElementById('opr-st-2').innerText = data.actuador2 ? "ON" : "OFF";
        }

        // Acciones de Escritura
        function setManualMode() {
            if (!db) return;
            db.ref('sistema/modo_manual').set(!isManualMode);
        }

        function sendActuator(num, state) {
            if (!db || !isManualMode) return;
            db.ref(`sistema/manual/actuador${num}`).set(state);
        }

        window.onload = initFirebase;
    </script>

</body></html>
